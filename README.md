# FTP Web System

一个基于Flask的现代化FTP管理系统，提供Web界面进行FTP站点管理、文件传输、任务调度和实时监控功能。

## 🚀 主要特性

### 核心功能
- **FTP站点管理**: 支持多个FTP站点的添加、编辑、删除和连接测试
- **文件传输**: 支持文件和文件夹的上传、下载，支持断点续传
- **任务调度**: 基于动态时间片的智能任务调度系统
- **实时监控**: 文件夹监控功能，自动检测和下载新文件
- **Web界面**: 现代化的响应式Web界面，支持实时更新
- **用户认证**: 基于角色的用户认证和权限管理

### 技术特性
- **动态时间片调度**: 根据任务类型和优先级动态分配执行时间
- **并发处理**: 支持多线程并发执行任务
- **数据持久化**: JSON文件存储，支持自动备份和原子操作
- **实时通信**: 基于WebSocket的实时状态更新
- **断点续传**: 支持大文件的断点续传功能
- **错误恢复**: 自动恢复未完成的任务

## 📋 系统要求

- Python 3.7+
- 支持的操作系统: Windows, Linux, macOS
- 内存: 最少512MB RAM
- 磁盘空间: 根据传输文件大小而定

## 🛠️ 安装部署

### 1. 克隆项目
```bash
git clone <repository-url>
cd FTPWebSystem-Augment/Web
```

### 2. 安装依赖
```bash
pip install -r requirements.txt
```

### 3. 配置环境
```bash
# 设置Flask环境（可选）
export FLASK_ENV=development  # 或 production
```

### 4. 启动系统
```bash
python run.py
```

系统将在 `http://localhost:5000` 启动。

## 📁 项目结构

```
Web/
├── app/                    # 应用主目录
│   ├── core/              # 核心模块
│   │   ├── ftp_client.py  # FTP客户端
│   │   └── scheduler.py   # 任务调度器
│   ├── models/            # 数据模型
│   │   └── data_manager.py # 数据管理器
│   ├── services/          # 业务服务
│   │   ├── task_service.py      # 任务服务
│   │   └── connection_service.py # 连接服务
│   ├── views/             # 视图控制器
│   │   ├── auth.py        # 用户认证
│   │   ├── dashboard.py   # 仪表板
│   │   ├── sites.py       # 站点管理
│   │   ├── tasks.py       # 任务管理
│   │   └── api.py         # API接口
│   └── utils/             # 工具模块
├── data/                  # 数据存储目录
│   ├── ftp_sites.json     # FTP站点配置
│   ├── transfer_tasks.json # 传输任务数据
│   ├── monitor_tasks.json  # 监控任务数据
│   ├── users.json         # 用户数据
│   ├── logs/              # 日志文件
│   ├── backups/           # 数据备份
│   └── uploads/           # 上传文件临时目录
├── downloads/             # 下载文件目录
├── static/                # 静态资源
│   ├── css/               # 样式文件
│   └── js/                # JavaScript文件
├── templates/             # HTML模板
├── config.py              # 配置文件
├── run.py                 # 启动文件
└── requirements.txt       # 依赖包列表
```

## 🔧 核心模块详解

### 1. FTP客户端 (app/core/ftp_client.py)
- 支持标准FTP协议连接
- 实现文件上传、下载功能
- 支持断点续传
- 目录浏览和文件列表获取
- 连接状态管理和错误处理

### 2. 动态时间片调度器 (app/core/scheduler.py)
- **智能调度算法**: 根据任务类型和优先级动态分配时间片
- **任务类型支持**:
  - 文件下载/上传 (2.0x时间倍数)
  - 文件夹下载/上传 (2.5x时间倍数)
  - 文件夹监控 (0.5x时间倍数)
  - 文件夹同步 (1.5x时间倍数)
  - 连接测试 (0.2x时间倍数)
- **优先级系统**: 高/中/低三级优先级
- **并发控制**: 支持最多3个工作线程并发执行

### 3. 数据管理器 (app/models/data_manager.py)
- **原子操作**: 确保数据写入的原子性
- **自动备份**: 定期备份数据文件（默认5分钟间隔）
- **线程安全**: 使用锁机制保证并发安全
- **数据恢复**: 支持从备份文件恢复数据

### 4. 任务服务 (app/services/task_service.py)
- **任务类型**:
  - 文件下载任务
  - 文件上传任务
  - 文件夹下载任务
  - 文件夹上传任务
  - 文件夹监控任务
  - 连接测试任务
- **任务状态管理**: 待执行、执行中、已完成、失败、暂停
- **进度跟踪**: 实时更新任务执行进度

## 🌐 Web界面功能

### 1. 用户认证
- 用户登录/登出
- 基于角色的权限控制（管理员/普通用户）
- 会话管理

### 2. 仪表板 (Dashboard)
- 系统状态概览
- 任务执行统计
- 实时任务进度显示
- 系统资源监控

### 3. FTP站点管理
- 添加/编辑/删除FTP站点
- 连接测试功能
- 站点分组管理
- 批量操作支持

### 4. 任务管理
- 创建各类传输任务
- 任务队列查看
- 任务状态控制（暂停/恢复/取消）
- 任务历史记录

### 5. 文件浏览器
- 远程FTP目录浏览
- 文件/文件夹操作
- 批量选择和操作
- 实时目录刷新

## 📊 配置说明

### 主要配置项 (config.py)

```python
# 任务调度配置
MAX_WORKERS = 3                    # 最大工作线程数

# 基础时间片配置（秒）
BASE_TIME_SLICES = {
    'high': 120,                   # 高优先级：2分钟
    'medium': 60,                  # 中优先级：1分钟
    'low': 30                      # 低优先级：30秒
}

# FTP配置
FTP_TIMEOUT = 30                   # FTP连接超时（秒）
FTP_CHUNK_SIZE = 8192             # 传输块大小

# 监控配置
MONITOR_INTERVAL = 60             # 监控检查间隔（秒）

# 上传配置
MAX_CONTENT_LENGTH = 500 * 1024 * 1024  # 最大上传文件大小：500MB
```

## 🚀 使用指南

### 1. 首次使用

1. **启动系统**后，访问 `http://localhost:5000`
2. **默认管理员账户**:
   - 用户名: `admin`
   - 密码: `admin123`
3. **建议立即修改默认密码**

### 2. 添加FTP站点

1. 进入"站点管理"页面
2. 点击"添加站点"
3. 填写FTP服务器信息:
   - 站点名称
   - 主机地址
   - 端口号（默认21）
   - 用户名和密码
   - 协议类型（FTP）
4. 点击"测试连接"验证配置
5. 保存站点配置

### 3. 创建传输任务

#### 文件下载任务
1. 选择源FTP站点
2. 浏览并选择要下载的文件
3. 设置本地保存路径
4. 选择任务优先级
5. 提交任务

#### 文件夹监控任务
1. 选择要监控的FTP站点
2. 设置远程监控路径
3. 设置本地下载路径
4. 配置文件过滤规则
5. 设置监控间隔
6. 启动监控任务

### 4. 任务管理

- **查看任务状态**: 在任务管理页面查看所有任务的实时状态
- **控制任务执行**: 可以暂停、恢复或取消正在执行的任务
- **查看任务日志**: 点击任务详情查看执行日志和错误信息

## 🔌 API接口

系统提供RESTful API接口，支持程序化操作：

### 认证接口
```
POST /auth/login          # 用户登录
POST /auth/logout         # 用户登出
GET  /auth/profile        # 获取用户信息
```

### 站点管理接口
```
GET    /api/sites                    # 获取站点列表
POST   /api/sites                    # 添加站点
PUT    /api/sites/<site_id>          # 更新站点
DELETE /api/sites/<site_id>          # 删除站点
POST   /api/sites/<site_id>/test     # 测试连接
POST   /api/sites/<site_id>/browse   # 浏览目录
```

### 任务管理接口
```
GET    /api/tasks                    # 获取任务列表
POST   /api/tasks                    # 创建任务
PUT    /api/tasks/<task_id>          # 更新任务
DELETE /api/tasks/<task_id>          # 删除任务
POST   /api/tasks/<task_id>/pause    # 暂停任务
POST   /api/tasks/<task_id>/resume   # 恢复任务
```

### WebSocket事件
```
connect                   # 客户端连接
disconnect               # 客户端断开
task_progress            # 任务进度更新
task_status_changed      # 任务状态变更
system_status            # 系统状态更新
```

## 🛡️ 安全特性

### 1. 用户认证
- 密码使用PBKDF2算法加密存储
- 基于会话的用户认证
- 角色权限控制

### 2. 数据安全
- FTP密码使用Base64编码存储
- 数据文件原子写入，防止数据损坏
- 定期自动备份重要数据

### 3. 网络安全
- FTP连接超时控制
- 错误重试机制
- 连接状态监控

## 🔧 故障排除

### 常见问题

#### 1. 无法连接FTP服务器
- 检查网络连接
- 验证FTP服务器地址和端口
- 确认用户名和密码正确
- 检查防火墙设置

#### 2. 任务执行失败
- 查看任务日志获取详细错误信息
- 检查磁盘空间是否充足
- 验证文件路径权限
- 确认FTP服务器稳定性

#### 3. 系统启动失败
- 检查Python版本兼容性
- 确认所有依赖包已正确安装
- 检查端口5000是否被占用
- 查看启动日志获取错误详情

#### 4. 文件传输中断
- 系统支持断点续传，重新启动任务即可继续
- 检查网络连接稳定性
- 确认FTP服务器支持断点续传

### 日志文件位置
- 应用日志: `data/logs/`
- 任务执行日志: 在任务详情中查看
- 系统错误日志: 控制台输出

## 📈 性能优化

### 1. 系统配置优化
```python
# 根据服务器性能调整工作线程数
MAX_WORKERS = 5  # 增加并发任务数

# 调整时间片大小以适应网络环境
BASE_TIME_SLICES = {
    'high': 180,    # 增加高优先级时间片
    'medium': 90,   # 增加中优先级时间片
    'low': 45       # 增加低优先级时间片
}

# 优化传输块大小
FTP_CHUNK_SIZE = 16384  # 增加块大小提高传输效率
```

### 2. 监控任务优化
- 合理设置监控间隔，避免过于频繁的检查
- 使用文件过滤规则减少不必要的传输
- 定期清理已完成的任务记录

### 3. 存储优化
- 定期清理日志文件
- 管理下载文件存储空间
- 优化数据备份策略

## 🤝 贡献指南

### 开发环境设置
1. Fork项目仓库
2. 创建开发分支
3. 安装开发依赖
4. 运行测试确保功能正常

### 代码规范
- 遵循PEP 8 Python代码规范
- 添加适当的注释和文档字符串
- 编写单元测试覆盖新功能
- 提交前运行代码检查

### 提交流程
1. 创建功能分支
2. 实现功能并测试
3. 提交Pull Request
4. 代码审查和合并

## 📄 许可证

本项目采用MIT许可证，详见LICENSE文件。

## 📞 支持与反馈

如有问题或建议，请通过以下方式联系：

- 提交Issue到项目仓库
- 发送邮件至项目维护者
- 参与项目讨论

## 🔄 版本历史

### v1.0.0 (当前版本)
- 基础FTP站点管理功能
- 文件传输任务支持
- 动态时间片调度系统
- Web界面和API接口
- 用户认证和权限管理
- 文件夹监控功能
- 断点续传支持

---

**感谢使用FTP Web System！** 🎉